#!/usr/bin/env python3
"""
categorize_bills.py - è­°æ¡ˆåã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬è¦ç´„ãƒ»å½±éŸ¿å¯¾è±¡ã‚’è‡ªå‹•ä»˜ä¸
ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¾æ›¸ï¼‰ã§ç„¡æ–™å®Ÿè¡Œã€‚

ä½¿ã„æ–¹:
  python categorize_bills.py
  python categorize_bills.py --dry-run   # DBæ›´æ–°ãªã—ã€çµæœã ã‘è¡¨ç¤º
"""

import os
import sys
import re
import argparse
from supabase import create_client

SUPABASE_URL = os.environ.get("SUPABASE_URL", "")
SUPABASE_KEY = os.environ.get("SUPABASE_SERVICE_KEY", "")

if not SUPABASE_URL or not SUPABASE_KEY:
    print("ERROR: SUPABASE_URL and SUPABASE_SERVICE_KEY must be set")
    sys.exit(1)

supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

# ============================================
# æ”¿ç­–ã‚«ãƒ†ã‚´ãƒªè¾æ›¸
# (ã‚«ãƒ†ã‚´ãƒªå, ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ, å½±éŸ¿ãƒ†ãƒ³ãƒ—ãƒ¬)
# å„ªå…ˆåº¦é †ï¼ˆä¸Šã‹ã‚‰é †ã«ãƒãƒƒãƒã€‚å…ˆã«ãƒãƒƒãƒã—ãŸã‚‚ã®ãŒå„ªå…ˆï¼‰
# ============================================

CATEGORIES = [
    # --- å…·ä½“çš„ãªãƒ†ãƒ¼ãƒï¼ˆå…ˆã«ãƒãƒƒãƒã•ã›ã‚‹ï¼‰---
    # â˜… å„ªå…ˆåº¦ãŒé‡è¦: ç¤¾ä¼šä¿éšœã‚’é‡‘èã‚ˆã‚Šå‰ã«ç½®ãï¼ˆã€Œä¿é™ºã€ã®èª¤ãƒãƒƒãƒé˜²æ­¢ï¼‰
    {
        "name": "æ†²æ³•ãƒ»çµ±æ²»æ©Ÿæ§‹",
        "keywords": ["æ†²æ³•", "å›½æ°‘æŠ•ç¥¨", "çµ±æ²»", "çš‡å®¤", "å¤©çš‡", "å›½äº‹è¡Œç‚º", "å…ƒå·"],
        "affected": "å›½æ°‘å…¨èˆ¬ã€ç«‹æ³•ãƒ»è¡Œæ”¿ãƒ»å¸æ³•æ©Ÿé–¢",
    },
    {
        "name": "é¸æŒ™ãƒ»æ”¿æ²»åˆ¶åº¦",
        "keywords": ["é¸æŒ™", "å…¬è·é¸æŒ™", "æ”¿æ²»è³‡é‡‘", "æ”¿å…šåŠ©æˆ", "åŒºå‰²ã‚Š", "å®šæ•°",
                      "å›½æ°‘å¯©æŸ»", "ä½æ°‘æŠ•ç¥¨", "æ”¿æ²»å€«ç†", "å…¬é¸æ³•"],
        "affected": "æœ‰æ¨©è€…ã€æ”¿å…šãƒ»å€™è£œè€…ã€é¸æŒ™ç®¡ç†å§”å“¡ä¼š",
    },
    {
        "name": "å®‰å…¨ä¿éšœãƒ»é˜²è¡›",
        "keywords": ["é˜²è¡›", "è‡ªè¡›éšŠ", "å®‰å…¨ä¿éšœ", "æ­¦åŠ›", "æœ‰äº‹", "ãƒŸã‚µã‚¤ãƒ«",
                      "è»äº‹", "æµ·ä¸Šä¿å®‰", "ãƒ†ãƒ­å¯¾ç­–", "ã‚µã‚¤ãƒãƒ¼æ”»æ’ƒ",
                      "PKO", "å›½éš›å¹³å’Œ", "æ ¸å…µå™¨", "æ ¸å®Ÿé¨“", "è»ç¸®"],
        # â˜…ã€ŒåŸºåœ°ã€ã‚’é™¤å»ï¼ˆå®‡å®™åŸºåœ°ãŒèª¤ãƒãƒƒãƒï¼‰
        "affected": "è‡ªè¡›éšŠå“¡ãƒ»å®¶æ—ã€é˜²è¡›ç”£æ¥­ã€åœ¨æ—¥ç±³è»é–¢ä¿‚è€…ã€å‘¨è¾ºä½æ°‘",
    },
    {
        "name": "å¤–äº¤ãƒ»å›½éš›é–¢ä¿‚",
        "keywords": ["æ¡ç´„", "å”å®š", "å¤–äº¤", "åœ¨å¤–", "é ˜äº‹", "å¤§ä½¿",
                      "ODA", "çµŒæ¸ˆé€£æº", "è¼¸å‡ºå…¥", "é€šå•†", "EPA", "FTA", "TPP",
                      "æ‰¿èªã‚’æ±‚ã‚ã‚‹"],
        # â˜…ã€Œå›½éš›ã€ã‚’é™¤å»ï¼ˆç¯„å›²ãŒåºƒã™ãï¼‰ã€ã€Œæ‰¿èªã‚’æ±‚ã‚ã‚‹ã€ã§æ¡ç´„æ¡ˆã‚’ç¢ºå®Ÿã«æ•æ‰
        "affected": "è¼¸å‡ºå…¥ä¼æ¥­ã€è¾²æ—æ°´ç”£æ¥­è€…ã€å¤–äº¤å½“å±€ã€åœ¨å¤–é‚¦äºº",
    },
    {
        "name": "ç¨åˆ¶",
        "keywords": ["æ‰€å¾—ç¨", "æ³•äººç¨", "æ¶ˆè²»ç¨", "ç›¸ç¶šç¨", "è´ˆä¸ç¨", "é…’ç¨",
                      "ãŸã°ã“ç¨", "å°ç´™ç¨", "é–¢ç¨", "ç§Ÿç¨", "ç¨åˆ¶", "èª²ç¨",
                      "æ¸›ç¨", "å¢—ç¨", "ç´ç¨", "ç¨ç‡", "å¾´ç¨"],
        "affected": "ç´ç¨è€…ï¼ˆå€‹äººãƒ»ä¼æ¥­ï¼‰ã€ç¨ç†å£«ã€è‡ªæ²»ä½“ã®ç¨å",
    },
    {
        "name": "è²¡æ”¿ãƒ»äºˆç®—",
        "keywords": ["äºˆç®—", "è²¡æ”¿", "å›½å‚µ", "è£œæ­£äºˆç®—", "æš«å®šäºˆç®—", "æ±ºç®—",
                      "è²¡æ”¿æŠ•èè³‡", "ç‰¹åˆ¥ä¼šè¨ˆ", "ä¸€èˆ¬ä¼šè¨ˆ", "æ­³å…¥", "æ­³å‡º",
                      "å›½æœ‰è²¡ç”£", "è²¡ç”£ç›®éŒ²", "è²¸å€Ÿå¯¾ç…§è¡¨", "æç›Šè¨ˆç®—æ›¸"],
        # â˜… ä¼šè¨ˆå ±å‘Šç³»ã‚’è¿½åŠ ï¼ˆNHKè²¡ç”£ç›®éŒ²ç­‰ï¼‰
        "affected": "å›½æ°‘å…¨èˆ¬ï¼ˆäºˆç®—é…åˆ†ï¼‰ã€å„çœåºã€åœ°æ–¹è‡ªæ²»ä½“",
    },
    # â˜… ç¤¾ä¼šä¿éšœã‚’é‡‘èã‚ˆã‚Šå‰ã«ï¼ˆã€Œä¿é™ºã€ã®å„ªå…ˆåº¦åˆ¶å¾¡ï¼‰
    {
        "name": "ç¤¾ä¼šä¿éšœãƒ»å¹´é‡‘",
        "keywords": ["å¹´é‡‘", "ç¤¾ä¼šä¿éšœ", "ä»‹è­·", "ç”Ÿæ´»ä¿è­·", "ç¦ç¥‰", "éšœå®³è€…",
                      "éšœå®³", "å…ç«¥ç¦ç¥‰", "é«˜é½¢è€…", "å¾ŒæœŸé«˜é½¢", "å›½æ°‘å¥åº·ä¿é™º",
                      "å¥åº·ä¿é™º", "åšç”Ÿå¹´é‡‘", "å›½æ°‘å¹´é‡‘", "é›‡ç”¨ä¿é™º",
                      "ç¤¾ä¼šç¦ç¥‰", "è€äºº", "æ©çµ¦", "æ‰¶åŠ©", "å…±æ¸ˆ"],
        "affected": "å¹´é‡‘å—çµ¦è€…ã€ä»‹è­·åˆ©ç”¨è€…ãƒ»äº‹æ¥­è€…ã€ä¿é™ºæ–™è² æ‹…è€…ã€è‡ªæ²»ä½“",
    },
    {
        "name": "åŒ»ç™‚ãƒ»å¥åº·",
        "keywords": ["åŒ»ç™‚", "ç—…é™¢", "åŒ»å¸«", "çœ‹è­·", "è–¬äº‹", "åŒ»è–¬å“", "æ„ŸæŸ“ç—‡",
                      "äºˆé˜²æ¥ç¨®", "å¥åº·", "ãŒã‚“", "é›£ç—…", "è‡“å™¨ç§»æ¤", "å†ç”ŸåŒ»ç™‚",
                      "æ–°å‹ã‚³ãƒ­ãƒŠ", "ãƒ‘ãƒ³ãƒ‡ãƒŸãƒƒã‚¯", "ãƒ¯ã‚¯ãƒãƒ³", "æ¤œç–«",
                      "è¡›ç”Ÿ", "ä¿å¥", "åŒ»å­¦", "è–¬å‰¤"],
        "affected": "æ‚£è€…ã€åŒ»ç™‚å¾“äº‹è€…ã€è£½è–¬ä¼æ¥­ã€åŒ»ç™‚æ©Ÿé–¢",
    },
    {
        "name": "é‡‘èãƒ»çµŒæ¸ˆ",
        "keywords": ["é‡‘è", "éŠ€è¡Œ", "è¨¼åˆ¸", "æ ªå¼", "ç‚ºæ›¿", "æŠ•è³‡",
                      "æ—¥æœ¬éŠ€è¡Œ", "ä¿¡ç”¨", "è²¸é‡‘", "ä»®æƒ³é€šè²¨", "æš—å·è³‡ç”£",
                      "ç‹¬å ç¦æ­¢", "å…¬æ­£å–å¼•", "æ™¯æ°—", "ç‰©ä¾¡", "ãƒ‡ãƒ•ãƒ¬",
                      "ä¸­å°ä¼æ¥­", "ç”£æ¥­ç«¶äº‰åŠ›", "æå®³ä¿é™º", "ç”Ÿå‘½ä¿é™º", "ä¿é™ºæ¥­",
                      "çµŒæ¸ˆ", "ç”£æ¥­", "ä¼æ¥­", "å•†å·¥", "ç‰¹è¨±"],
        # â˜…ã€Œä¿é™ºã€â†’å…·ä½“çš„ãªã€Œæå®³ä¿é™ºã€ã€Œç”Ÿå‘½ä¿é™ºã€ã€Œä¿é™ºæ¥­ã€ã«å¤‰æ›´
        "affected": "é‡‘èæ©Ÿé–¢ã€æŠ•è³‡å®¶ã€ä¸­å°ä¼æ¥­ã€æ¶ˆè²»è€…",
    },
    {
        "name": "å­è‚²ã¦ãƒ»æ•™è‚²",
        "keywords": ["æ•™è‚²", "å­¦æ ¡", "å¤§å­¦", "ç¾©å‹™æ•™è‚²", "å¥¨å­¦é‡‘", "æˆæ¥­æ–™",
                      "ä¿è‚²", "å­è‚²ã¦", "å…ç«¥æ‰‹å½“", "å°‘å­åŒ–", "ã“ã©ã‚‚",
                      "å¹¼ç¨šåœ’", "çµ¦é£Ÿ", "ä¸ç™»æ ¡", "ã„ã˜ã‚", "å­¦è¡“", "å›³æ›¸é¤¨",
                      "é’å°‘å¹´", "å‡ºç”£", "è‚²å…"],
        "affected": "å…ç«¥ãƒ»ç”Ÿå¾’ãƒ»å­¦ç”Ÿã€ä¿è­·è€…ã€æ•™è‚²æ©Ÿé–¢ã€ä¿è‚²å£«",
    },
    {
        "name": "åŠ´åƒãƒ»é›‡ç”¨",
        "keywords": ["åŠ´åƒ", "é›‡ç”¨", "è³ƒé‡‘", "æœ€ä½è³ƒé‡‘", "åŠ´åƒåŸºæº–", "æ´¾é£",
                      "ãƒ‘ãƒ¼ãƒˆ", "è‚²å…ä¼‘æ¥­", "è‚²ä¼‘", "éåŠ´", "åƒãæ–¹", "ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ",
                      "åŠ´ç½", "è·æ¥­å®‰å®š", "è§£é›‡", "é€€è·", "å¤±æ¥­", "å°±è·",
                      "å‹¤å‹™", "è·æ¥­è¨“ç·´", "æŠ€èƒ½"],
        # â˜…ã€Œè§£é›‡ã€ã€Œé€€è·ã€ã€Œå¤±æ¥­ã€ç­‰ã‚’è¿½åŠ 
        "affected": "åŠ´åƒè€…ã€ä¼æ¥­ï¼ˆé›‡ç”¨ä¸»ï¼‰ã€åŠ´åƒçµ„åˆã€äººææ´¾é£æ¥­",
    },
    {
        "name": "ç’°å¢ƒãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼",
        "keywords": ["ç’°å¢ƒ", "æ¸©æš–åŒ–", "CO2", "æ’å‡º", "å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼",
                      "åŸå­åŠ›", "åŸç™º", "é›»åŠ›", "ã‚¨ãƒãƒ«ã‚®ãƒ¼", "è„±ç‚­ç´ ",
                      "å…¬å®³", "å»ƒæ£„ç‰©", "ãƒªã‚µã‚¤ã‚¯ãƒ«", "ç”Ÿç‰©å¤šæ§˜æ€§", "è‡ªç„¶ä¿è­·",
                      "çŸ³æ²¹", "å¤©ç„¶ã‚¬ã‚¹", "æ°´è³ª", "å¤§æ°—"],
        "affected": "ã‚¨ãƒãƒ«ã‚®ãƒ¼äº‹æ¥­è€…ã€æ’å‡ºä¼æ¥­ã€æ¶ˆè²»è€…ï¼ˆé›»æ°—ä»£ï¼‰ã€åœ°åŸŸä½æ°‘",
    },
    {
        "name": "è¾²æ—æ°´ç”£",
        "keywords": ["è¾²æ¥­", "è¾²åœ°", "è¾²ç”£ç‰©", "ç•œç”£", "æ¼æ¥­", "æ°´ç”£", "æ—æ¥­",
                      "é£Ÿæ–™", "é£Ÿå“", "ç±³", "é…ªè¾²", "æœ‰æ©Ÿ", "JA", "è¾²å”",
                      "æ£®æ—", "æœ¨æ", "æ¼èˆ¹", "é¤Šæ®–", "ç‰§å ´", "è¾²æ‘",
                      "å®¶ç•œ", "é£¼æ–™", "è‚¥æ–™", "ç¨®è‹—"],
        # â˜…ã€Œæ¼èˆ¹ã€ã€Œé¤Šæ®–ã€ç­‰ã‚’è¿½åŠ 
        "affected": "è¾²æ—æ°´ç”£æ¥­è€…ã€é£Ÿå“ç”£æ¥­ã€æ¶ˆè²»è€…ï¼ˆé£Ÿæ–™ä¾¡æ ¼ï¼‰ã€åœ°åŸŸçµŒæ¸ˆ",
    },
    {
        "name": "å›½åœŸãƒ»äº¤é€šãƒ»ã‚¤ãƒ³ãƒ•ãƒ©",
        "keywords": ["é“è·¯", "é‰„é“", "èˆªç©º", "æ¸¯æ¹¾", "ç©ºæ¸¯", "é«˜é€Ÿé“è·¯",
                      "æ–°å¹¹ç·š", "å»ºè¨­", "å»ºç¯‰", "ä½å®…", "ä¸å‹•ç”£", "éƒ½å¸‚è¨ˆç”»",
                      "å›½åœŸ", "äº¤é€š", "é‹è¼¸", "ç‰©æµ", "æµ·é‹", "è‡ªå‹•è»Š",
                      "åœŸåœ°", "æ²³å·", "ãƒ€ãƒ ", "æ°´é“", "ä¸‹æ°´", "æ©‹æ¢"],
        "affected": "åˆ©ç”¨è€…ï¼ˆé€šå‹¤ãƒ»ç‰©æµï¼‰ã€å»ºè¨­æ¥­ã€ä¸å‹•ç”£æ¥­ã€åœ°åŸŸä½æ°‘",
    },
    {
        "name": "åœ°æ–¹è‡ªæ²»ãƒ»åœ°æ–¹å‰µç”Ÿ",
        "keywords": ["åœ°æ–¹è‡ªæ²»", "åœ°æ–¹å‰µç”Ÿ", "åœ°æ–¹åˆ†æ¨©", "åœ°æ–¹äº¤ä»˜ç¨", "éç–",
                      "å¸‚ç”ºæ‘", "éƒ½é“åºœçœŒ", "åˆä½µ", "åœ°åŸŸæ´»æ€§", "ãµã‚‹ã•ã¨",
                      "é›¢å³¶", "æ²–ç¸„", "åŒ—æµ·é“é–‹ç™º", "ç‰¹åŒº"],
        "affected": "åœ°æ–¹è‡ªæ²»ä½“ã€åœ°æ–¹ä½æ°‘ã€åœ°æ–¹ä¼æ¥­ã€ç§»ä½å¸Œæœ›è€…",
    },
    {
        "name": "ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ç§‘å­¦æŠ€è¡“",
        "keywords": ["ãƒ‡ã‚¸ã‚¿ãƒ«", "IT", "AI", "æƒ…å ±é€šä¿¡", "ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼",
                      "å€‹äººæƒ…å ±", "ã‚µã‚¤ãƒãƒ¼", "å®‡å®™", "ç§‘å­¦æŠ€è¡“", "ç ”ç©¶é–‹ç™º",
                      "çŸ¥çš„è²¡ç”£", "è‘—ä½œæ¨©", "é€šä¿¡", "æ”¾é€",
                      "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ", "é›»å­", "ãƒ‡ãƒ¼ã‚¿", "ãƒ­ãƒœãƒƒãƒˆ"],
        # â˜…ã€ŒNHKã€ã€Œç‰¹è¨±ã€ã‚’é™¤å»ï¼ˆèª¤ãƒãƒƒãƒé˜²æ­¢ï¼‰
        "affected": "ITä¼æ¥­ã€ç ”ç©¶æ©Ÿé–¢ã€åˆ©ç”¨è€…ï¼ˆå€‹äººæƒ…å ±ï¼‰ã€ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—",
    },
    {
        "name": "æ³•å‹™ãƒ»å¸æ³•",
        "keywords": ["åˆ‘æ³•", "æ°‘æ³•", "å•†æ³•", "ä¼šç¤¾æ³•", "åˆ‘äº‹è¨´è¨Ÿ", "æ°‘äº‹è¨´è¨Ÿ",
                      "å°‘å¹´æ³•", "è£åˆ¤", "è£åˆ¤æ‰€", "æ³•å‹™", "ç™»è¨˜", "æˆ¸ç±",
                      "å…¥ç®¡", "å‡ºå…¥å›½", "é›£æ°‘", "åœ¨ç•™", "å¸°åŒ–", "å›½ç±",
                      "å¼è­·å£«", "å¸æ³•æ›¸å£«", "å…¬è¨¼", "ç ´ç”£", "å€’ç”£"],
        "affected": "æ³•æ›¹é–¢ä¿‚è€…ã€å½“äº‹è€…ï¼ˆæ°‘äº‹ãƒ»åˆ‘äº‹ï¼‰ã€å¤–å›½äººã€ä¼æ¥­ï¼ˆã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ï¼‰",
    },
    {
        "name": "äººæ¨©ãƒ»å…±ç”Ÿ",
        "keywords": ["äººæ¨©", "å·®åˆ¥", "ç”·å¥³å…±åŒå‚ç”»", "ã‚¸ã‚§ãƒ³ãƒ€ãƒ¼", "LGBT",
                      "åŒæ€§", "ãƒ˜ã‚¤ãƒˆ", "éšœå®³è€…æ¨©åˆ©", "ã‚¢ã‚¤ãƒŒ", "éƒ¨è½",
                      "å¤–å›½äººåŠ´åƒè€…", "æŠ€èƒ½å®Ÿç¿’", "ãƒãƒªã‚¢ãƒ•ãƒªãƒ¼", "å…±ç”Ÿ"],
        "affected": "ãƒã‚¤ãƒãƒªãƒ†ã‚£å½“äº‹è€…ã€ä¼æ¥­ï¼ˆãƒ€ã‚¤ãƒãƒ¼ã‚·ãƒ†ã‚£ï¼‰ã€è‡ªæ²»ä½“ã€æ•™è‚²æ©Ÿé–¢",
    },
    {
        "name": "ç½å®³ãƒ»é˜²ç½",
        "keywords": ["ç½å®³", "åœ°éœ‡", "æ´¥æ³¢", "å°é¢¨", "æ´ªæ°´", "é˜²ç½", "å¾©èˆˆ",
                      "è¢«ç½", "é¿é›£", "è€éœ‡", "æ¶ˆé˜²", "æ•‘æ€¥", "å¾©æ—§",
                      "å™´ç«", "è±ªé›¨", "åœŸç ‚"],
        "affected": "è¢«ç½è€…ã€è‡ªæ²»ä½“ã€æ¶ˆé˜²ãƒ»æ•‘æ€¥ã€å»ºè¨­æ¥­ã€ä¿é™ºæ¥­",
    },
    {
        "name": "æ²»å®‰ãƒ»è­¦å¯Ÿ",
        "keywords": ["è­¦å¯Ÿ", "çŠ¯ç½ª", "æš´åŠ›å›£", "çµ„ç¹”çŠ¯ç½ª", "è–¬ç‰©", "éŠƒå™¨",
                      "è©æ¬º", "ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼", "DV", "äº¤é€šå®‰å…¨", "å°‘å¹´çŠ¯ç½ª",
                      "å†çŠ¯", "åˆ‘å‹™æ‰€", "æ›´ç”Ÿ", "éº»è–¬", "è¦šé†’å‰¤"],
        "affected": "å¸‚æ°‘ï¼ˆå®‰å…¨ï¼‰ã€è­¦å¯Ÿæ©Ÿé–¢ã€è¢«å®³è€…ãƒ»åŠ å®³è€…ã€æ›´ç”Ÿæ”¯æ´å›£ä½“",
    },
    # â˜… è¡Œæ”¿æ”¹é©ï¼ˆæ–°ã‚«ãƒ†ã‚´ãƒªï¼‰â€” ç‰¹æ®Šæ³•äººã€ç‹¬æ³•ã€è¡Œæ”¿æ©Ÿæ§‹ã®æ”¹ç·¨
    {
        "name": "è¡Œæ”¿æ”¹é©ãƒ»çµ±æ²»",
        "keywords": ["ç‰¹æ®Šæ³•äºº", "ç‹¬ç«‹è¡Œæ”¿æ³•äºº", "è¡Œæ”¿æ”¹é©", "å…¬å‹™å“¡", "äººäº‹é™¢",
                      "è¡Œæ”¿æ©Ÿé–¢", "çœåº", "è¨­ç½®æ³•", "çµ„ç¹”æ³•", "å®šå“¡", "çµ¦ä¸æ³•",
                      "å›½å®¶å…¬å‹™å“¡", "åœ°æ–¹å…¬å‹™å“¡", "è¡Œæ”¿æ‰‹ç¶š"],
        "affected": "å…¬å‹™å“¡ã€è¡Œæ”¿æ©Ÿé–¢ã€å›½æ°‘ï¼ˆè¡Œæ”¿ã‚µãƒ¼ãƒ“ã‚¹ã®è³ªï¼‰",
    },
]


def categorize_bill(bill_name: str, bill_type: str = "") -> dict:
    """
    è­°æ¡ˆåã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã€ãƒ†ãƒ³ãƒ—ãƒ¬è¦ç´„ã€å½±éŸ¿å¯¾è±¡ã‚’è¿”ã™ã€‚
    """
    result = {
        "category": None,
        "category_sub": None,
        "summary_template": None,
        "affected_groups": None,
    }

    # ã‚«ãƒ†ã‚´ãƒªåˆ†é¡ï¼ˆæœ€åˆã«ãƒãƒƒãƒã—ãŸã‚‚ã®ã‚’ãƒ¡ã‚¤ãƒ³ã€2ç•ªç›®ã‚’ã‚µãƒ–ï¼‰
    matched = []
    for cat in CATEGORIES:
        for kw in cat["keywords"]:
            if kw in bill_name:
                matched.append(cat)
                break

    if matched:
        result["category"] = matched[0]["name"]
        result["affected_groups"] = matched[0]["affected"]
        if len(matched) >= 2:
            result["category_sub"] = matched[1]["name"]

    # ãƒ†ãƒ³ãƒ—ãƒ¬è¦ç´„ã®ç”Ÿæˆ
    result["summary_template"] = generate_summary(bill_name, bill_type, result["category"])

    return result


def generate_summary(bill_name: str, bill_type: str, category: str | None) -> str:
    """è­°æ¡ˆåã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬è¦ç´„ã‚’ç”Ÿæˆ"""

    # æå‡ºè€…ã‚¿ã‚¤ãƒ—
    type_label = ""
    if bill_type == "é–£æ³•":
        type_label = "æ”¿åºœæå‡ºã€‚"
    elif bill_type == "è¡†æ³•" or bill_type == "å‚æ³•":
        type_label = "è­°å“¡ç«‹æ³•ã€‚"

    # ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ
    name = bill_name

    # ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã€Œâ—‹â—‹æ³•ã®ä¸€éƒ¨ã‚’æ”¹æ­£ã™ã‚‹æ³•å¾‹æ¡ˆã€
    m = re.search(r'(.+?)ã®ä¸€éƒ¨ã‚’æ”¹æ­£ã™ã‚‹æ³•å¾‹æ¡ˆ', name)
    if m:
        law_name = m.group(1).strip()
        cat_hint = f"ï¼ˆ{category}åˆ†é‡ï¼‰" if category else ""
        return f"{type_label}{law_name}ã®è¦å®šã‚’æ”¹æ­£ã—ã€{cat_hint}åˆ¶åº¦ã‚’è¦‹ç›´ã™æ³•æ¡ˆã€‚"

    # ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã€Œâ—‹â—‹ã«é–¢ã™ã‚‹æ³•å¾‹æ¡ˆã€
    m = re.search(r'(.+?)ã«é–¢ã™ã‚‹æ³•å¾‹æ¡ˆ', name)
    if m:
        topic = m.group(1).strip()
        return f"{type_label}{topic}ã«ã¤ã„ã¦æ–°ãŸãªæ³•çš„æ çµ„ã¿ã‚’å®šã‚ã‚‹æ³•æ¡ˆã€‚"

    # ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã€Œâ—‹â—‹ã«é–¢ã—è¬›ãšã¹ãæªç½®ã«é–¢ã™ã‚‹æ³•å¾‹æ¡ˆã€
    m = re.search(r'(.+?)ã«é–¢ã—è¬›ãšã¹ã', name)
    if m:
        topic = m.group(1).strip()
        return f"{type_label}{topic}ã«å¯¾å‡¦ã™ã‚‹ãŸã‚ã€æ”¿åºœãŒå®Ÿæ–½ã™ã‚‹æªç½®ã‚’å®šã‚ã‚‹æ³•æ¡ˆã€‚"

    # ãƒ‘ã‚¿ãƒ¼ãƒ³4: ã€Œâ—‹â—‹æ³•æ¡ˆã€
    m = re.search(r'(.+?)æ³•æ¡ˆ$', name)
    if m:
        topic = m.group(1).strip()
        return f"{type_label}{topic}ã«é–¢ã™ã‚‹æ³•æ¡ˆã€‚"

    # ãƒ‘ã‚¿ãƒ¼ãƒ³5: äºˆç®—
    if "äºˆç®—" in name:
        return f"{type_label}å›½ã®äºˆç®—æ¡ˆã€‚å›½ã®æ­³å…¥ãƒ»æ­³å‡ºã®è¨ˆç”»ã‚’å®šã‚ã‚‹ã€‚"

    # ãƒ‘ã‚¿ãƒ¼ãƒ³6: æ¡ç´„
    if bill_type == "æ¡ç´„" or "æ¡ç´„" in name or "å”å®š" in name:
        return f"å›½éš›çš„ãªå–ã‚Šæ±ºã‚ã€‚å›½ä¼šã®æ‰¿èªã‚’çµŒã¦ç· çµã•ã‚Œã‚‹ã€‚"

    # ãƒ‘ã‚¿ãƒ¼ãƒ³7: æ±ºè­°
    if "æ±ºè­°" in name:
        return f"å›½ä¼šã¨ã—ã¦ã®æ„æ€ã‚’è¡¨æ˜ã™ã‚‹æ±ºè­°æ¡ˆã€‚æ³•çš„æ‹˜æŸåŠ›ã¯ãªã„ã€‚"

    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    cat_hint = f"{category}ã«é–¢ã™ã‚‹" if category else ""
    return f"{type_label}{cat_hint}è­°æ¡ˆã€‚"


def main():
    parser = argparse.ArgumentParser(description="è­°æ¡ˆã‚«ãƒ†ã‚´ãƒªè‡ªå‹•åˆ†é¡")
    parser.add_argument("--dry-run", action="store_true", help="DBæ›´æ–°ãªã—")
    args = parser.parse_args()

    # å…¨billså–å¾—
    print("è­°æ¡ˆãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...")
    all_bills = []
    offset = 0
    page_size = 1000
    while True:
        result = supabase.table("bills") \
            .select("id, bill_name, bill_type") \
            .range(offset, offset + page_size - 1) \
            .execute()
        rows = result.data or []
        all_bills.extend(rows)
        if len(rows) < page_size:
            break
        offset += page_size

    print(f"  {len(all_bills)}ä»¶ã®è­°æ¡ˆã‚’å–å¾—")

    # åˆ†é¡
    categorized = 0
    uncategorized = 0
    category_counts: dict[str, int] = {}
    updates = []

    for bill in all_bills:
        cat = categorize_bill(bill["bill_name"], bill.get("bill_type", ""))
        if cat["category"]:
            categorized += 1
            category_counts[cat["category"]] = category_counts.get(cat["category"], 0) + 1
        else:
            uncategorized += 1

        updates.append({
            "id": bill["id"],
            "category": cat["category"],
            "category_sub": cat["category_sub"],
            "summary_template": cat["summary_template"],
            "affected_groups": cat["affected_groups"],
        })

    # çµ±è¨ˆ
    print(f"\n=== åˆ†é¡çµæœ ===")
    print(f"  åˆ†é¡æˆåŠŸ: {categorized}ä»¶ ({categorized*100//len(all_bills)}%)")
    print(f"  æœªåˆ†é¡: {uncategorized}ä»¶")
    print(f"\n  ã‚«ãƒ†ã‚´ãƒªåˆ¥:")
    for cat, cnt in sorted(category_counts.items(), key=lambda x: -x[1]):
        print(f"    {cat}: {cnt}ä»¶")

    # ã‚µãƒ³ãƒ—ãƒ«è¡¨ç¤º
    print(f"\n=== ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€åˆã®20ä»¶ï¼‰ ===")
    for u in updates[:20]:
        bill = next(b for b in all_bills if b["id"] == u["id"])
        print(f"\n  ğŸ“œ {bill['bill_name']}")
        print(f"     ã‚«ãƒ†ã‚´ãƒª: {u['category'] or 'æœªåˆ†é¡'}" + (f" / {u['category_sub']}" if u['category_sub'] else ""))
        print(f"     è¦ç´„: {u['summary_template']}")
        print(f"     å½±éŸ¿: {u['affected_groups'] or 'â€”'}")

    if args.dry_run:
        print(f"\nâš ï¸ --dry-run ãƒ¢ãƒ¼ãƒ‰: DBæ›´æ–°ã¯ã‚¹ã‚­ãƒƒãƒ—")
        return

    # DBæ›´æ–°
    print(f"\n--- DBæ›´æ–°ä¸­ ---")
    batch_size = 200
    for i in range(0, len(updates), batch_size):
        batch = updates[i:i + batch_size]
        for item in batch:
            supabase.table("bills").update({
                "category": item["category"],
                "category_sub": item["category_sub"],
                "summary_template": item["summary_template"],
                "affected_groups": item["affected_groups"],
            }).eq("id", item["id"]).execute()
        done = min(i + batch_size, len(updates))
        if done % 500 < batch_size:
            print(f"  æ›´æ–°: {done}/{len(updates)}")

    print(f"\nâœ… åˆ†é¡å®Œäº†! {categorized}ä»¶ã«ã‚«ãƒ†ã‚´ãƒªã‚’ä»˜ä¸ã—ã¾ã—ãŸ")


if __name__ == "__main__":
    main()
